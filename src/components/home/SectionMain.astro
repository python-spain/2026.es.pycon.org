---
import { texts } from '../../i18n/home'
import TextBox from '../TextBox.astro'

interface Props {
  lang: string
}

const { lang } = Astro.props
const t = texts[lang as keyof typeof texts]
---

<div class="mt-20 p-20 flex gap-4 flex-col lg:flex-row">
  <div class="flex-1">
    <h1>
      <img
        src="/images/logo-vertical-alt-color-dark.svg"
        alt="PyconES Barcelona 2026"
        class="h-80 mx-auto mb-4"
      />
    </h1>

    <h2
      id="subtitle-container"
      class="mt-4 text-xl md:text-2xl text-pycon-red-75 font-mono h-8 flex justify-center items-start gap-2 [text-shadow:0_0_3px_var(--color-pycon-black),0_0_6px_var(--color-pycon-black),0_0_6px_var(--color-pycon-black),0_0_12px_var(--color-pycon-black)]"
      aria-live="polite"
      aria-busy="true"
    >
      <span aria-hidden="true" class="select-none">&gt;</span>
      <span id="subtitle" data-final-text={t['index.subtitle']}>
        {t['index.initializing']}
        <span class="animate-pulse motion-reduce:animate-none" aria-hidden="true">_</span>
      </span>
    </h2>
  </div>
  <TextBox text={t['index.message']} />
</div>

<script>
  const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()_+'

  let interval: number | null = null

  const runMatrixEffect = (element: HTMLElement) => {
    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches
    if (prefersReducedMotion) return

    let iteration = 0
    clearInterval(interval as number)
    const originalText = element.dataset.value || ''

    interval = window.setInterval(() => {
      element.innerText = originalText
        .split('')
        .map((_, index) => {
          if (index < iteration) {
            return originalText[index]
          }
          return letters[Math.floor(Math.random() * letters.length)]
        })
        .join('')

      if (iteration >= originalText.length) {
        clearInterval(interval as number)
      }

      iteration += 1 / 3
    }, 30)
  }

  const init = () => {
    const matrixText = document.getElementById('matrix-text')
    const h1 = document.querySelector('h1')
    const subtitle = document.getElementById('subtitle')
    const actions = document.querySelector('#actions')

    if (matrixText && h1) {
      runMatrixEffect(matrixText)
      h1.onmouseover = () => runMatrixEffect(matrixText)
    }

    if (subtitle) {
      setTimeout(() => {
        const finalText = subtitle.dataset.finalText
        if (finalText) {
          subtitle.textContent = finalText
        }
        const container = document.getElementById('subtitle-container')
        if (container) {
          container.setAttribute('aria-busy', 'false')
        }
        if (actions) {
          actions.classList.remove('opacity-0')
        }
      }, 1500)
    }
  }

  init()
</script>
