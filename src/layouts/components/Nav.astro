---
import { getEntry } from 'astro:content'
import { Astronav, MenuItems, MenuIcon } from 'astro-navbar'
import { ClientRouter } from 'astro:transitions'

const menuData = await getEntry('menu', 'main')

if (!menuData) {
  throw new Error('No se encontró el archivo src/content/menu/main.json')
}

const { items } = menuData.data
const currentPath = Astro.url.pathname

// FIX: Función segura que no falla si el item no tiene href
function isItemActive(href?: string | null) {
  if (!href || !currentPath) return false
  const normalize = (path: string) => path.replace(/\/$/, '')
  return normalize(currentPath) === normalize(href)
}
---

<ClientRouter />

<header class="fixed top-0 w-full z-[100] bg-slate-900/95 backdrop-blur-md border-b border-white/10">
  <div class="container mx-auto px-4 h-20 flex items-center justify-between">
    <Astronav>
      <div class="flex w-full lg:w-auto items-center justify-between">
        <a
          href="/"
          class="text-2xl font-bold font-mono tracking-tighter text-white rounded px-2 py-1 outline-none focus-visible:ring-2 focus-visible:ring-blue-400"
          aria-label="PyCon ES - Ir al inicio"
        >
          PyCon<span class="text-blue-500">ES</span>
        </a>

        <div class="block lg:hidden">
          <button
            id="mobile-menu-trigger"
            aria-label="Alternar menú móvil"
            class="rounded p-1 text-white hover:bg-white/10 outline-none focus-visible:ring-2 focus-visible:ring-blue-400"
          >
            <MenuIcon class="w-8 h-8 pointer-events-none" />
          </button>
        </div>
      </div>

      <MenuItems class="hidden lg:flex w-full lg:w-auto">
        <ul class="flex flex-col lg:flex-row gap-2 lg:gap-8 mt-4 lg:mt-0 pb-4 lg:pb-0">
          {
            items.map((item) => {
              const active = isItemActive(item.href)

              return (
                <li class="relative group">
                  {item.children ? (
                    <>
                      <button
                        type="button"
                        class="dropdown-btn flex items-center gap-1 w-full text-left font-medium py-2 lg:py-0 transition-colors rounded outline-none focus-visible:ring-2 focus-visible:ring-blue-400 text-slate-300 hover:text-white"
                        aria-expanded="false"
                        aria-haspopup="true"
                      >
                        {item.label}
                        <svg
                          class="arrow-icon w-4 h-4 transition-transform duration-200 pointer-events-none"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                          aria-hidden="true"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M19 9l-7 7-7-7"
                          />
                        </svg>
                      </button>

                      <div class="dropdown-content hidden absolute top-full left-0 w-64 pt-2 z-50">
                        <div class="bg-slate-900 rounded-lg p-2 shadow-xl border border-white/10 ring-1 ring-black/5">
                          <ul>
                            {item.children.map((child) => (
                              <li>
                                <a
                                  href={child.href}
                                  class="block px-4 py-3 rounded-md text-white font-medium transition-colors hover:bg-white/5 outline-none focus-visible:ring-2 focus-visible:ring-blue-400 focus-visible:bg-slate-800"
                                >
                                  {child.label}
                                  {child.description && (
                                    <span class="block text-sm text-slate-400 mt-0.5 pointer-events-none">
                                      {child.description}
                                    </span>
                                  )}
                                </a>
                              </li>
                            ))}
                          </ul>
                        </div>
                      </div>
                    </>
                  ) : (
                    <a
                      href={item.href}
                      class:list={[
                        'block font-medium py-2 lg:py-0 transition-colors rounded outline-none focus-visible:ring-2 focus-visible:ring-blue-400',
                        active ? 'text-white cursor-default' : 'text-slate-300 hover:text-white',
                      ]}
                      aria-current={active ? 'page' : undefined}
                    >
                      {item.label}
                    </a>
                  )}
                </li>
              )
            })
          }
        </ul>
      </MenuItems>
    </Astronav>
  </div>
</header>

<style>
  /* NOTA: Hemos eliminado la apertura por :hover (CSS) intencionalmente.
     Esto asegura que el comportamiento de Toggle (abrir/cerrar) mediante click
     sea consistente y no entre en conflicto con el estado del ratón.
  */

  /* Clases de estado que el JS activará/desactivará */
  .show-dropdown {
    display: block !important;
    animation: fadeIn 0.15s ease-out forwards;
  }

  .rotate-arrow {
    transform: rotate(180deg);
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(-5px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>

<script>
  function setupInteractiveMenu() {
    const dropdownBtns = document.querySelectorAll('.dropdown-btn')

    // Función centralizada para limpiar todo el estado (cerrar todo)
    const closeAll = () => {
      document.querySelectorAll('.dropdown-content').forEach((el) => el.classList.remove('show-dropdown'))
      document.querySelectorAll('.arrow-icon').forEach((el) => el.classList.remove('rotate-arrow'))
      document.querySelectorAll('.dropdown-btn').forEach((el) => el.setAttribute('aria-expanded', 'false'))
    }

    // 1. GESTIÓN DE DROPDOWNS (Click Toggle)
    dropdownBtns.forEach((btn) => {
      // Clonamos para eliminar listeners antiguos (Crucial para ClientRouter)
      const newBtn = btn.cloneNode(true) as HTMLElement
      btn.parentNode?.replaceChild(newBtn, btn)

      newBtn.addEventListener('click', (e) => {
        e.stopPropagation() // Evitar que el evento suba y cierre inmediatamente

        // 1. Guardamos el estado actual ANTES de cerrar todo
        const wasExpanded = newBtn.getAttribute('aria-expanded') === 'true'

        // 2. Cerramos todos los menús (limpieza general)
        closeAll()

        // 3. Lógica Toggle:
        // Si NO estaba abierto, lo abrimos.
        // Si SÍ estaba abierto, no hacemos nada (ya lo cerró closeAll), logrando el efecto de cerrar.
        if (!wasExpanded) {
          const content = newBtn.nextElementSibling as HTMLElement
          const arrow = newBtn.querySelector('.arrow-icon')

          if (content) {
            content.classList.add('show-dropdown')
            newBtn.setAttribute('aria-expanded', 'true')
            arrow?.classList.add('rotate-arrow')
          }
        }
      })
    })

    // 2. CERRAR AL HACER CLICK FUERA
    const handleOutsideClick = (e: MouseEvent) => {
      const target = e.target as HTMLElement
      // Si el click NO es dentro de un grupo (dropdown), cerramos todo
      if (!target.closest('.group')) {
        closeAll()
      }
    }

    // Gestión limpia de eventos globales (Evita duplicados en navegación)
    document.removeEventListener('click', handleOutsideClick)
    document.addEventListener('click', handleOutsideClick)

    // 3. TECLA ESCAPE (Accesibilidad)
    const handleEsc = (e: KeyboardEvent) => {
      if (e.key === 'Escape') {
        closeAll()
        // Devolver foco al botón que estaba abierto
        const openBtn = document.querySelector('.dropdown-btn[aria-expanded="true"]') as HTMLElement
        if (openBtn) openBtn.focus()
      }
    }
    document.removeEventListener('keydown', handleEsc)
    document.addEventListener('keydown', handleEsc)

    // 4. MÓVIL (Lógica Toggle para AstroNavbar)
    const mobileBtn = document.getElementById('mobile-menu-trigger')
    if (mobileBtn) {
      const newMobileBtn = mobileBtn.cloneNode(true) as HTMLElement
      mobileBtn.parentNode?.replaceChild(newMobileBtn, mobileBtn)

      newMobileBtn.addEventListener('click', (e) => {
        e.stopPropagation()
        const menu =
          document.querySelector('.astronav-items') || document.querySelector('nav > div:last-child')
        if (menu) {
          menu.classList.toggle('hidden')
          menu.classList.toggle('flex')
        }
      })
    }

    // 5. ANTI-FLICKER (Solo si es el mismo enlace)
    const links = document.querySelectorAll('a[href]')
    links.forEach((link) => {
      const newLink = link.cloneNode(true) as HTMLAnchorElement
      link.parentNode?.replaceChild(newLink, link)

      newLink.addEventListener('click', (e) => {
        // Solo prevenimos la acción si vamos EXACTAMENTE a la misma página
        if (newLink.href === window.location.href) {
          e.preventDefault()
        }
      })
    })
  }

  // Ejecución inicial
  setupInteractiveMenu()

  // Re-ejecución en navegación SPA (View Transitions)
  document.addEventListener('astro:page-load', setupInteractiveMenu)
</script>
